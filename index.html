<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NJZ头像生成器-懒人版</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    @font-face {
      font-family: 'yaheibold';
      src: url('yaheibold.ttc') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;700&display=swap');
    
    :root {
      --primary-color: #6A5ACD;
      --text-color: #333;
      --bg-color: #F4F6FA;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
      background-color: var(--bg-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      color: var(--text-color);
    }
    
    .container {
      background-color: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      width: 100%;
      max-width: 450px;
      padding: 30px;
    }
    
    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 20px;
      font-size: 1.8rem;
      font-family: 'yaheibold', 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
    }
    
    .instructions {
      background-color: rgba(106, 90, 205, 0.05);
      border-left: 4px solid var(--primary-color);
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    
    .instructions ul {
      list-style-type: none;
      padding-left: 10px;
    }
    
    .instructions li {
      margin-bottom: 8px;
      position: relative;
      padding-left: 20px;
    }
    
    .instructions li:before {
      content: '•';
      color: var(--primary-color);
      position: absolute;
      left: 0;
    }
    
    .upload-btn, #generate-btn {
      display: block;
      width: 60%;
      margin-left: auto;
      margin-right: auto;
      padding: 12px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 1rem;
    }
    
    .upload-btn:hover, #generate-btn:hover {
      background-color: #5A4ACD;
    }
    
    #canvas-container {
      width: 100%;
      aspect-ratio: 1 / 1;
      background-image: url('bg.jpeg');
      background-size: cover;
      background-position: center;
      position: relative;
      border-radius: 12px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    #avatar {
      position: absolute;
      width: 50%;
      height: 50%;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      cursor: grab;
      touch-action: none;
      /* 初始居中 */
      left: 25%;
      top: 25%;
      transform: scale(1);
    }
    
    #avatar:active {
      cursor: grabbing;
    }
    
    #generate-btn:disabled {
      cursor: not-allowed;
      background-color: #cccccc;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>NJZ头像生成器-懒人版</h1>
    
    <div class="instructions">
      <ul>
        <li>请用浏览器打开</li>
        <li>如已有透明底图片，推荐使用<a href="https://nobreadnolife.github.io/newavatar/" style="color: var(--primary-color);">常规版生成器</a></li>
        <li>图片可拖拽/放大/缩小</li>
        <li>点击"生成头像"查看保存</li>
      </ul>
    </div>
    
    <label for="upload" class="upload-btn">上传图片</label>
    <input type="file" id="upload" accept="image/*" style="display:none;">
    
    <div id="canvas-container">
      <div id="avatar"></div>
    </div>
    
    <button id="generate-btn" disabled>生成头像</button>
  </div>
  
  <script>
    const uploadInput = document.getElementById('upload');
    const avatar = document.getElementById('avatar');
    const generateBtn = document.getElementById('generate-btn');
    const canvasContainer = document.getElementById('canvas-container');
    
    // 用于记录缩放比例，初始为 1
    let scale = 1.0;
    let isDragging = false;
    let startX, startY;
    
    // 让头像初始居中
    function centerAvatar() {
      const containerRect = canvasContainer.getBoundingClientRect();
      const baseSize = containerRect.width * 0.5;
      avatar.style.left = (containerRect.width - baseSize) / 2 + 'px';
      avatar.style.top = (containerRect.height - baseSize) / 2 + 'px';
    }
    window.addEventListener('resize', centerAvatar);
    centerAvatar();
    
    // 上传图片后设置头像背景，重置缩放和位置
    uploadInput.addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function (e) {
        scale = 1.0;
        avatar.style.transform = 'scale(1)';
        centerAvatar();
        
        avatar.style.backgroundImage = `url(${e.target.result})`;
        generateBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    });
    
    // 鼠标拖拽
    avatar.addEventListener('mousedown', (e) => {
      isDragging = true;
      startX = e.clientX - parseFloat(avatar.style.left);
      startY = e.clientY - parseFloat(avatar.style.top);
      avatar.style.cursor = 'grabbing';
    });
    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        avatar.style.left = (e.clientX - startX) + 'px';
        avatar.style.top = (e.clientY - startY) + 'px';
      }
    });
    document.addEventListener('mouseup', () => {
      isDragging = false;
      avatar.style.cursor = 'grab';
    });
    
    // 触摸拖拽
    avatar.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        isDragging = true;
        startX = e.touches[0].clientX - parseFloat(avatar.style.left);
        startY = e.touches[0].clientY - parseFloat(avatar.style.top);
        avatar.style.cursor = 'grabbing';
      }
    });
    document.addEventListener('touchmove', (e) => {
      if (isDragging && e.touches.length === 1) {
        avatar.style.left = (e.touches[0].clientX - startX) + 'px';
        avatar.style.top = (e.touches[0].clientY - startY) + 'px';
      }
    });
    document.addEventListener('touchend', () => {
      isDragging = false;
      avatar.style.cursor = 'grab';
    });
    
    // 鼠标滚轮缩放
    avatar.addEventListener('wheel', (e) => {
      e.preventDefault();
      const scaleFactor = e.deltaY < 0 ? 1.1 : 0.9;
      scale *= scaleFactor;
      scale = Math.max(0.5, Math.min(3, scale));
      avatar.style.transform = `scale(${scale})`;
    });
    
    // 触摸缩放
    let lastTouchDistance = 0;
    avatar.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2) {
        lastTouchDistance = Math.hypot(
          e.touches[0].pageX - e.touches[1].pageX,
          e.touches[0].pageY - e.touches[1].pageY
        );
      }
    });
    avatar.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2) {
        const touchDistance = Math.hypot(
          e.touches[0].pageX - e.touches[1].pageX,
          e.touches[0].pageY - e.touches[1].pageY
        );
        const scaleFactor = touchDistance / lastTouchDistance;
        scale *= scaleFactor;
        scale = Math.max(0.5, Math.min(3, scale));
        avatar.style.transform = `scale(${scale})`;
        lastTouchDistance = touchDistance;
      }
    });
    
    // 生成头像
    generateBtn.addEventListener('click', () => {
      // 创建一个临时画布来合并背景和头像
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      
      // 设置画布大小与容器相同
      tempCanvas.width = canvasContainer.offsetWidth;
      tempCanvas.height = canvasContainer.offsetHeight;
      
      // 绘制背景
      const bgImage = new Image();
      bgImage.src = 'bg.jpeg';
      bgImage.onload = () => {
        // 绘制背景
        tempCtx.drawImage(bgImage, 0, 0, tempCanvas.width, tempCanvas.height);
        
        // 创建头像图片
        const avatarImg = new Image();
        avatarImg.src = avatar.style.backgroundImage.slice(5, -2);
        avatarImg.onload = () => {
          // 计算头像的绘制位置和大小
          const avatarLeft = parseFloat(avatar.style.left);
          const avatarTop = parseFloat(avatar.style.top);
          const avatarWidth = avatar.offsetWidth * scale;
          const avatarHeight = avatar.offsetHeight * scale;
          
          // 绘制头像
          tempCtx.save();
          tempCtx.beginPath();
          tempCtx.arc(
            avatarLeft + avatarWidth / 2, 
            avatarTop + avatarHeight / 2, 
            avatarWidth / 2, 
            0, 
            Math.PI * 2
          );
          tempCtx.clip();
          tempCtx.drawImage(
            avatarImg, 
            avatarLeft, 
            avatarTop, 
            avatarWidth, 
            avatarHeight
          );
          tempCtx.restore();
          
          // 打开新窗口并显示生成的图片
          const dataUrl = tempCanvas.toDataURL('image/png');
          const newWindow = window.open();
          newWindow.document.write(`
            <html>
            <head>
              <style>
                body { 
                  display: flex; 
                  justify-content: center; 
                  align-items: center; 
                  height: 100vh; 
                  margin: 0; 
                  background: #F4F6FA;
                }
                img { 
                  max-width: 90%; 
                  max-height: 90vh; 
                  border-radius: 50%; 
                }
              </style>
            </head>
            <body>
              <img src="${dataUrl}" alt="生成的头像">
            </body>
            </html>
          `);
          newWindow.document.close();
        };
      };
    });
  </script>
</body>
</html>